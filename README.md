<h1>PVE System.</h1>

<h2>üê±‚Äçüë§Features:</h2>

- Client management system built with Next.js.
- Hosted on Vercel, and utilizing Vercel services for db and local storage.
- This project is currently under development.

<h2>ü§ñTech:</h2>

![HTML](https://img.shields.io/badge/-HTML-05122A?style=flat&color=blue&logo=HTML5)
![CSS](https://img.shields.io/badge/-CSS-05122A?style=flat&color=blue&logo=CSS3)

![NEXTJS](https://img.shields.io/badge/-NextJS-05122A?style=flat&color=grey&logo=nextdotjs)
![MUI](https://img.shields.io/badge/-Material.UI-05122A?style=flat&color=pink&logo=mui)

![TYPESCRIPT](https://img.shields.io/badge/-typeScript-05122A?style=flat&color=9cf&logo=TYPESCRIPT)
![NODEJS](https://img.shields.io/badge/-nodeJS-05122A?style=flat&color=9cf&logo=node.js)

![POSTGRESQL](https://img.shields.io/badge/-PostgreSql-05122A?style=flat&color=red&logo=POSTGRESQL)
![VERCEL](https://img.shields.io/badge/-VERCEL-05122A?style=flat&color=darkblue&logo=vercel)

<h2>üìÅProject Structure:</h2>

### FrontEnd

The project follows a modular organization to ensure maintainability and scalability:

- `app/`: Contains pages that render components modularly.

All pages in the project are located directly under the app/ folder, following the latest Next.js routing structure.

Example: The main client page is implemented in `app/ClientPage/page.tsx` and uses components like ClientPageTabInfos.

- `app/components/`: Contains reusable frontend components.

Each component is responsible for managing its own logic, API calls, and rendering the frontend.

Example: `app/components/ClientPageTabInfos/ClientPageTabInfos.tsx` is responsible for rendering client information and making related API calls.

- Styles: Styling is applied within the same folder as the component using a file named styles.ts.

Example: The styles for the ClientPageTabInfos component are defined in `app/components/ClientPageTabInfos/styles.ts`.

### BackEnd

- `app/api/`: Contains all backend logic and API endpoints, following the Next.js structure.

Example: The /api/getClient route is implemented in `app/api/getClient/route.ts`.

## Database setup

The project uses Drizzle ORM for database management with PostgreSQL, offering an approach with efficient migrations, schema definitions and queries.
This ensures that database operations are reliable, easy to maintain, and in line with TypeScript's strong typing.

‚ö†Ô∏è Important:

Due to some functionalities that emerged after the project went into production, it‚Äôs important to know that:

- The `clients` table does not have a direct foreign key to the `users` table.
- However, the `responsibleSeller` field in `clients` stores the same value as `operatorNumber` in `users`, creating a relationship between the tables.
- Check out a method that has been implemented and documented in the file `app/api/getSalesQuotesByState/route.ts`.

Spin up the database with:

```bash
npm run db:up
```

Spin down the database with:

```bash
npm run db:down
```

### Migrations

Generate the database migration based on the schema changes:

```bash
npm run db:generate -- --name <migration-name>
```

Run the migrations with:

```bash
npm run db:migrate
```

<h2>üöÄ Test Environment Automation (Vercel Branch Preview)</h2>

This project features an automated flow for creating and removing test and approval environments for each Pull Request, using GitHub Actions,
Neon Database, and Vercel Preview Deploys.

üîß How it works:
Automatic creation of a parallel DB in a new branch on Neon.

1- Whenever a Pull Request is opened, reopened, or synchronized, a new database branch is automatically created in Neon,
based on the name of the PR branch. It maintains the data and schema of the latest version of the main DB.

2- Migrations are executed automatically.

3- The credentials of the new branch are added as environment variables in Vercel (only for the Preview environment).

4- Automatic deployment with Vercel. Every time there‚Äôs a change in the open PR branch, Vercel performs a new Preview Deploy.

5- The Preview application is already connected to the new database instance corresponding to the PR branch.

6- A new link is automatically generated by Vercel, allowing the client to access an isolated version for testing, previewing, and approval,
without affecting the production environment.

7- Automatic removal. When the Pull Request is closed, the database branch in Neon is automatically deleted.

Note: The only manual removal required is deleting the environment variable that was automatically created in Vercel (step 3):
`pve-system/settings/environment-variables`

<h2>üöÄ Automation for Production Deployment (Vercel Branch Production)</h2>

This workflow is responsible for automating the deployment to the production environment after the final approval of changes.
It is triggered whenever a Pull Request is merged into the main branch, after the changes have passed tests and validations in the preview environment.

üîß How it works:
The workflow executes the following steps:

1- Checks out the repository and installs project dependencies, bringing an updated copy of the main branch into the runner.

2- Executes migrations on the production database using production credentials, which are defined as secret variables in GitHub and synchronized with Vercel.

3- Automatically sets and synchronizes environment variables with the Vercel project, ensuring that the production environment in Vercel uses the latest secret variables configured in GitHub.

4- Builds the application and deploys it to the Vercel production environment.

5- Creates a deployment in GitHub with status and a direct link to the production environment. From this process, Vercel only hosts the ready build.

6- In case of a deployment failure, an issue is automatically created with error details and a link to the GitHub Actions logs.

![alt text](image.png)

<h3>üê±‚ÄçüèçAll rights reserved. ¬© 2024 - PVE Representa√ß√µes Ltda.üê±‚Äçüèç</h3>
